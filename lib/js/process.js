const dropzone=document.getElementById("dropzone"),fileInput=document.getElementById("fileInput"),selectedFileName=document.getElementById("selectedFileName"),statistics=document.getElementById("statistics"),durationEl=document.getElementById("duration"),filamentWeightEl=document.getElementById("filamentWeight"),loader=document.getElementById("loader"),progressBar=document.getElementById("progressBar"),progressText=document.getElementById("progressText"),processBtn=document.getElementById("processBtn"),loopCountInput=document.getElementById("loopCount");let selectedFile=null,baseStatistics=null;function showToast(e,t=!1){let s=document.getElementById("toast");s.textContent=e,s.className=t?"show error":"show",setTimeout(()=>s.className="",3e3)}function validateFile(e){return e.name.endsWith(".3mf")?!(e.size>15728640)||(showToast("File size must be between 1 MB and 15 MB.",!0),!1):(showToast("Only .3mf files are supported.",!0),!1)}function formatDuration(e){return`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m ${e%60}s`}function updateStatistics(e){baseStatistics&&(durationEl.textContent=formatDuration(baseStatistics.duration*e),filamentWeightEl.textContent=`${(baseStatistics.filamentWeight*e).toFixed(1)}g`)}function extractStatistics(e){let t=14250,s=115.6;return e.split("\n").forEach(e=>{if(e.includes("; total estimated time:")){let l=e.match(/total estimated time: (\d+)m (\d+)s/);if(l){let i=parseInt(l[1]),n=parseInt(l[2]);t=60*i+n}}if(e.includes("; total filament weight [g] :")){let o=e.match(/total filament weight \[g\] : ([\d.]+)/);o&&(s=parseFloat(o[1]))}}),console.log(`Parsed statistics: duration=${t}s, filamentWeight=${s}g`),{duration:t,filamentWeight:s}}function multiplyGcode(e,t){let s=e.split("\n"),l=s.filter(e=>!e.startsWith(";")&&e.trim()&&!e.includes("START")&&!e.includes("END")),i=s.filter(e=>e.includes("START")||e.startsWith(";")).join("\n"),n=s.filter(e=>e.includes("END")).join("\n"),o=Array(t).fill(l.join("\n")).join("\n");return`${i}
${o}
${n}`.trim()}function triggerDownload(e,t){let s=document.createElement("a");s.href=URL.createObjectURL(e),s.download=t,s.click()}async function handleFile(e){if(validateFile(e)){selectedFile=e,selectedFileName.textContent=`Selected: ${e.name}`,showToast(`File "${e.name}" selected.`);try{let t=await e.arrayBuffer(),s=await JSZip.loadAsync(t),l=Object.keys(s.files).filter(e=>e.match(/^Metadata\/plate_.*\.gcode$/));if(1!==l.length){statistics.style.display="none",showToast("No valid G-code file found inside 3MF.",!0);return}let i=l[0],n=await s.files[i].async("string");baseStatistics=extractStatistics(n),updateStatistics(parseInt(loopCountInput.value)),statistics.style.display="block"}catch(o){showToast("Error extracting statistics.",!0),statistics.style.display="none"}}}async function processFile(){if(!selectedFile){showToast("No file selected.",!0);return}let e=parseInt(document.getElementById("loopCount").value),t=document.getElementById("outputName").value.trim();if(t||(t=selectedFile.name.replace(/\.3mf$/i,"")+`_loop_${e}`),e<1||e>100){showToast("Loop count must be between 1 and 100.",!0);return}let s=selectedFile.size*e;if(s>157286400){showToast("Output file may exceed 150 MB. Reduce loop count.",!0);return}let l=performance.now();try{processBtn.classList.add("disabled"),loader.style.display="block",progressBar.style.width="0%",progressText.textContent="0%";let i=await selectedFile.arrayBuffer();progressBar.style.width="20%",progressText.textContent="20%";let n=await JSZip.loadAsync(i);progressBar.style.width="40%",progressText.textContent="40%";let o=Object.keys(n.files).filter(e=>e.match(/^Metadata\/plate_.*\.gcode$/));if(1!==o.length){showToast("No valid G-code file found inside 3MF.",!0);return}progressBar.style.width="60%",progressText.textContent="60%";let a=o[0],r=await n.files[a].async("string"),d=multiplyGcode(r,e);n.file(a,d),progressBar.style.width="80%",progressText.textContent="80%";let c=await n.generateAsync({type:"blob"});progressBar.style.width="100%",progressText.textContent="100%",triggerDownload(c,`${t}.3mf`),showToast("File processed and downloaded successfully!");let u=performance.now();console.log(`File Size: ${(selectedFile.size/1024/1024).toFixed(2)} MB`),console.log(`Processing Time: ${((u-l)/1e3).toFixed(2)} s`),fileInput.value="",selectedFile=null,baseStatistics=null,selectedFileName.textContent="",loopCountInput.value=1,document.getElementById("outputName").value="",statistics.style.display="none",progressBar.style.width="0%",progressText.textContent="0%"}catch(p){console.error(p),showToast(`Error processing the file: ${p.message}`,!0)}finally{setTimeout(()=>{loader.style.display="none"},500),processBtn.classList.remove("disabled")}}dropzone.addEventListener("click",()=>fileInput.click()),dropzone.addEventListener("dragover",e=>{e.preventDefault(),dropzone.style.background="#d3550020"}),dropzone.addEventListener("dragleave",()=>{dropzone.style.background="#d355000d"}),dropzone.addEventListener("drop",e=>{e.preventDefault(),dropzone.style.background="#d355000d",handleFile(e.dataTransfer.files[0])}),fileInput.addEventListener("change",()=>{fileInput.files.length>0&&handleFile(fileInput.files[0])}),loopCountInput.addEventListener("input",()=>{let e=parseInt(loopCountInput.value)||1;updateStatistics(e)});